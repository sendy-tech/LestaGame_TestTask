{% extends "base.html" %}
{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–æ–º{% endblock %}

{% block content %}
<h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–æ–º</h2>

{% if error %}
  <div class="flash-error">{{ error }}</div>
{% endif %}
{% if success %}
  <div class="flash-success">{{ success }}</div>
{% endif %}

<h3>–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</h3>
    <form method="post" action="/auth/change-password" id="change-password-form">
      <label for="old_password">–°—Ç–∞—Ä—ã–π –ø–∞—Ä–æ–ª—å:</label>
      <input type="password" name="old_password" required>

      <label for="new_password">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å:</label>
      <div class="password-field">
        <input type="password" id="new_password" name="new_password" required oninput="updatePasswordUI()">
        <span class="toggle" onclick="toggleVisibility('new_password')">üëÅÔ∏è</span>
      </div>

      <label for="confirm_password">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è:</label>
      <div class="password-field">
        <input type="password" id="confirm_password" name="confirm_password" required oninput="updatePasswordUI()">
        <span class="toggle" onclick="toggleVisibility('confirm_password')">üëÅÔ∏è</span>
      </div>

      <div class="password-meter">
        <div id="strength-bar" class="strength-bar"></div>
      </div>

      <small id="password_hint" class="hint">–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 8 —Å–∏–º–≤–æ–ª–æ–≤, —Å–æ–¥–µ—Ä–∂–∞—Ç—å –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã.</small><br>
      <small id="match_hint" class="hint"></small>

      <button type="submit" id="submit-btn" disabled>–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
    </form>

    <hr>

    <h3>–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</h3>
    <form method="post" action="/auth/delete-account" onsubmit="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.')">
      <button type="submit" class="danger">–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
    </form>

  <script>
    function toggleVisibility(id) {
      const input = document.getElementById(id);
      input.type = input.type === "password" ? "text" : "password";
    }

    function updatePasswordUI() {
      const password = document.getElementById("new_password").value;
      const confirm = document.getElementById("confirm_password").value;
      const submit = document.getElementById("submit-btn");
      const hint = document.getElementById("password_hint");
      const matchHint = document.getElementById("match_hint");
      const strengthBar = document.getElementById("strength-bar");

      const lengthValid = password.length >= 8;
      const hasLetter = /[A-Za-z]/.test(password);
      const hasDigit = /\d/.test(password);

      if (!lengthValid || !hasLetter || !hasDigit) {
        hint.textContent = "–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 8 —Å–∏–º–≤–æ–ª–æ–≤, —Å–æ–¥–µ—Ä–∂–∞—Ç—å –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã.";
        hint.style.color = "red";
      } else {
        hint.textContent = "–ü–∞—Ä–æ–ª—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º.";
        hint.style.color = "green";
      }

      if (confirm === "") {
        matchHint.textContent = "";
      } else if (password !== confirm) {
        matchHint.textContent = "–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç.";
        matchHint.style.color = "red";
      } else {
        matchHint.textContent = "–ü–∞—Ä–æ–ª–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç.";
        matchHint.style.color = "green";
      }

      let score = 0;
      if (lengthValid) score++;
      if (hasLetter) score++;
      if (hasDigit) score++;

      const colors = ["#e74c3c", "#f39c12", "#2ecc71"];
      strengthBar.style.width = `${score * 33}%`;
      strengthBar.style.backgroundColor = colors[score - 1] || "#ddd";

      submit.disabled = !(lengthValid && hasLetter && hasDigit && password === confirm);
    }
  </script>
{% endblock %}